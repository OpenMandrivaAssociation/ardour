From ea01ec5988185228c41b7799b45c5051f0b80d15 Mon Sep 17 00:00:00 2001
From: Robin Gareus <robin@gareus.org>
Date: Tue, 30 Mar 2021 15:29:14 +0200
Subject: [PATCH] Correctly detect glib volatile atomic

see also https://gitlab.gnome.org/GNOME/glib/-/merge_requests/1919
---
 libs/pbd/pbd/g_atomic_compat.h | 2 +-
 wscript                        | 1 +
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/libs/pbd/pbd/g_atomic_compat.h b/libs/pbd/pbd/g_atomic_compat.h
index 5b0d167376..d13f606a45 100644
--- a/libs/pbd/pbd/g_atomic_compat.h
+++ b/libs/pbd/pbd/g_atomic_compat.h
@@ -30,7 +30,7 @@
  * Older versions of glib and older compilers still expect a volatile qualifier and print
  * "cast from type 'volatile long int*' to type 'long int*' casts away qualifiers [-Wcast-qual]"
  */
-#if defined __GNUC__ && __GNUC__ > 10
+#if defined HAVE_GLIB_2_68 && (defined(__cplusplus) && __cplusplus >= 201103L)
 #  define GATOMIC_QUAL
 #else
 #  define GATOMIC_QUAL volatile
diff --git a/wscript b/wscript
index 3ba49d7ec1..03909d7139 100644
--- a/wscript
+++ b/wscript
@@ -1148,6 +1148,7 @@ def configure(conf):
         conf.env.append_value('LDFLAGS', '-L/usr/X11R6/lib')
 
     autowaf.check_pkg(conf, 'glib-2.0', uselib_store='GLIB', atleast_version='2.28', mandatory=True)
+    autowaf.check_pkg(conf, 'glib-2.0', uselib_store='GLIB_2_68', atleast_version='2.68', mandatory=False)
     autowaf.check_pkg(conf, 'gthread-2.0', uselib_store='GTHREAD', atleast_version='2.2', mandatory=True)
     autowaf.check_pkg(conf, 'glibmm-2.4', uselib_store='GLIBMM', atleast_version='2.32.0', mandatory=True)
     autowaf.check_pkg(conf, 'sndfile', uselib_store='SNDFILE', atleast_version='1.0.18', mandatory=True)
